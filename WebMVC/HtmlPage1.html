<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
<head data-ej-android="true">
    <title>隐患信息</title>
    <meta charset="utf-8">
    <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="css/ui-box.css">
    <link rel="stylesheet" href="css/ui-base.css">
    <link rel="stylesheet" href="css/ui-color.css">
    <link rel="stylesheet" href="css/appcan.icon.css">
    <link rel="stylesheet" href="css/appcan.control.css">
    <link rel="stylesheet" href="css/fms.css">
    <style type="text/css">
        #yhDay {
            color: initial;
            cursor: initial;
        }

        #content {
            background-color: #f5f5f5 !important;
        }

        .group {
            padding: .75em .5em;
            background-color: #fff;
            border-bottom: 1px solid #e2e2e2;
        }

        .group_item {
            padding-bottom: .5em;
        }

        li[data-type='form_button_system'] .form-group label {
            display: none !important;
        }

        .no-replay {
            background: url(images/no-replay.png)
        }

        .filename {
            display: none !important;
        }

        .imgBox {
            width: 4em !important;
            height: 4em !important;
        }

        .p_errorMsg {
            padding-bottom: .5em;
            color: red;
        }
    </style>
    <script type="text/javascript" src="js/config.js"></script>
    <script type="text/javascript" src="js/appcan.min.js"></script>
    <script type="text/javascript" src="js/appcan.control.min.js"></script>
    <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="js/fms.widget.js"></script>
    <script type="text/javascript" src="js/fms.js"></script>
    <script type="text/javascript" src="js/fms.control.js"></script>
    <script type="text/javascript" src="js/project.js"></script>
    <script type="text/javascript" src="js/fms.extend.js"></script>

    <script type="text/javascript">
            Handlebars.registerHelper("formatReplay", function(type, item, options) {
                var _base_url_ = downip + "uploads/";
                var _base_img_url_ = 'images/suffix/';
                var fileType = {
                    image : _base_img_url_ + 'image.png',
                    txt : _base_img_url_ + 'txt.png',
                    ppt : _base_img_url_ + 'ppt.png',
                    word : _base_img_url_ + 'word.png',
                    excel : _base_img_url_ + 'excel.png',
                    audio : _base_img_url_ + 'audio.png',
                    video : _base_img_url_ + 'video.png',
                    other : _base_img_url_ + 'other.png'
                };

                var _base_url_ = downip + "uploads/";
                var url = _base_url_ + item.MsgContent_cutting;
                if (type === "image") {
                    return url;
                } else {
                    return fileType[type];
                }
            });

    </script>
    <!-- 回复模板 -->
    <script id="ReplyListTemp" type="text/x-handlebars-template">
        {{#if items}}
        <div class="ub ub-f1 ub-ver group">
            {{#each items}}
            <div class="ub ub-f1 ub-ac group_item" data-item="{{builddata this}}">
                <div class="ub ub-f1">

                    <div class="ub ub-ver ub-f1 uba bc-border uc-a1 uinn">

                        <div class="ub ub-f1 c-999 umar-b">

                            <div class="ub ut-s ulev-1">{{MsgRelayPrsnName}}</div>
                            <div class="ub italic umar-l ulev-1 ub-ac ub-pc">{{formatdatamonthday MsgDT}}</div>
                            <div class="ub ub-f1 ub-pe">
                                <div class="ub fa fa-phone mobile-call-action" data-phone-number="{{MsgRelayPrsnMobile}}"></div>
                            </div>

                        </div>
                        <div class="ub ub-f1 ulev-1 " onclick="showContent(this);" data-item="{{builddata this}}">
                            {{#ifdengyu MsgType 'text'}}
                            {{MsgContent}}
                            {{else}}
                            <div class="ub ub-f1 ub-ac ub-pe">
                                <img src="{{formatReplay MsgType this}}" onerror="errorHander(this)" class="default_img default_img_sm" />
                            </div>
                            {{/ifdengyu}}
                        </div>

                    </div>
                    <div class="ub ub-ac ub-pc umar-l">
                        <img class="ub default_img default_img_sm img-circle us mobile-call-action" data-phone-number="{{MsgRelayPrsnMobile}}" src="{{formatURL RelayPrsnLogoFile}}" onerror="errorHander(this,1)" style="margin-right: 0;" />
                    </div>

                </div>
            </div>
            {{/each}}
            {{fmsPager 0}}
        </div>
        {{else}}
        <div class="ub ub-f1 ub-ac ub-pc uinn5 c-bbb">暂无留言</div>
        {{/if}}
    </script>

    <!-- 隐患详情模板 -->
    <script id="YhDetailTemp" type="text/x-handlebars-template">
        <div class="ub ub-f1 ub-ver group">
            {{#each items}}
            <div class="ub ub-f1 ub-ver">
                <div class="ub ub-f1 group_item">
                    <div class="ub"><img class="default_img default_img_sm us img-circle" src="{{formatURL yhPrsnLogo}}" onerror="errorHander(this,1)" /></div>
                    <div class="ub ub-f1 ub-ver">
                        <div class="ub ub-f1 umar-t">
                            <div class="ub ub-f1 ut-s ulev1 c-333 mobile-call-action" data-phone-number="{{yhPrsnMobile}}">{{yhPrsnName}}</div>
                            <div class="ub ulev-1 c-bbb  umar-r">{{yh_Name}}</div>
                            <div class="ub ulev-1 c-bbb  umar-r">{{yhGrade}}</div>
                            <div class="ub ulev-1 c-bbb  ">{{yhStat}}</div>
                        </div>
                        <div class="ub ub-f1 umar-t">
                            <div class="ub ub-f1 ut-s ulev-1 c-bbb">{{formatdatamonthday yhDT}} </div>
                            <div class="ub ulev-1 c-bbb ">{{QName}}</div>
                        </div>
                    </div>
                </div>

                <div class="ub ub-f1 group_item  c-bbb ulev-1">该指令由<span class="c-06c mobile-call-action" data-phone-number="{{yhZxrMobile}}">【{{yhZxrName}}】</span>来执行，应于<span class="c-06c">【{{yhCpDT1}}】</span>前完成。 </div>
                <div class="ub ub-f1 group_item ">{{yhDesc}}</div>
                <div class="ub ub-f1 uinn ub-ae ub-pe">
                    <div class="btn btn bc-btn-white ub ub-f1 ub-ac  ub-pc c-7f8 uc-a1  " onclick="more(this);" id="more"><i class="fa fa-angle-down umar-r"></i>显示更多</div>
                </div>
                <div id="morediv" class="uhide group_item">

                    <div class="ub">隐患编号：  {{FormID}}</div>
                    <div class="ub">隐患描述：  {{yhContent}}</div>
                    <div class="ub">隐患位置： {{yhWz}}</div>
                    <div class="ub">隐患类型： {{yhfq}}</div>
                    {{#ifdengyu yhfq '内业'}}
                    <div class="ub">部门： {{deptName}}</div>
                    {{else}}
                    <div class="ub">发生位置： {{yhfswz_name}}</div>
                    <div class="ub">具体位置： {{yhfswz_bd_name}}</div>
                    {{/ifdengyu}}
                </div>

                <div class="ub ub-f1 ub-ver">
                    <div class="ub ub-f1">
                        <div class="img-list">

                            <div id="imglist" data-fms-type="imgbox"
                                 data-fms-imgbox-bg="css/images/addImg.png"
                                 data-fms-imgbox-more="true"
                                 data-fms-imgbox-guid="{{yhFile}}"
                                 data-fms-imgbox-file=""
                                 data-fms-imgbox-mode="read"
                                 data-fms-callback="formatFileName" data-fms-imgbox-style="watemark"></div>
                        </div>
                    </div>
                </div>
            </div>
            {{/each}}
        </div>
    </script>

    <script type="text/javascript" data-type="default">
            //页面附加菜单开始

            rightAppenMenu = [];

            //页面附加菜单结束
            //API配置开始

            //API配置结束
            //控件自动生成代码开始

            //控件自动生成代码结束
            //自定义JS代码开始

            //自定义JS代码结束
    </script>
</head>
<body class="um-vp bc-bg" ontouchstart="">

    <div id="page_0" class="up ub ub-ver" tabindex="0">
        <header data-fms-type="pagetop" data-fms-pagetop-title="隐患信息" data-fms-pagetop-leftaction="goBack" data-fms-pagetop-nav="true" data-fms-pagetop-add="true" id="header"></header>

        <div id="content" class="ub-f1 tx-l">
            <div id="listView2" data-type="listview" data-fms-type="listview" data-fms-templ="YhDetailTemp" class="list-group" data-fms-templ="" data-source="v_yh_zlfs" data-fms-list-currentpage="1" data-fms-list-key="FormID" data-fms-list-conditions="FormID:fms.local.getJson('yh_main').FormID;" data-fms-list-itemclick="" data-fms-list-success="YHAction" data-dataconfig="YH-022" data-datapagesize="1" data-datatype="0" data-primary="FormID" data-fms-datasource="YH-022">
                <ul style="display:none;" data-type="listview_info" data-title="FormID">
                    <li data-field="QNO" data-name="群号" data-show="True"></li>
                    <li data-field="QName" data-name="群名称" data-show="True"></li>
                    <li data-field="FormID" data-name="隐患编号" data-show="True"></li>
                    <li data-field="yhGrade" data-name="隐患等级" data-show="True"></li>
                    <li data-field="yhDesc" data-name="隐患内容" data-show="True"></li>
                    <li data-field="yhPrsn" data-name="隐患发现人编号" data-show="True"></li>
                    <li data-field="yhPrsnMobile" data-name="隐患发现人电话" data-show="True"></li>
                    <li data-field="yhPrsnName" data-name="隐患发现人姓名" data-show="True"></li>
                    <li data-field="yhDT" data-name="发现日期" data-show="True"></li>
                    <li data-field="yhStat" data-name="隐患状态" data-show="True"></li>
                    <li data-field="NextYhStat" data-name="隐患状态的下一个状态" data-show="True"></li>
                    <li data-field="yh_Name" data-name="隐患类别" data-show="True"></li>
                    <li data-field="yhZxr" data-name="执行人编号" data-show="True"></li>
                    <li data-field="yhZxrMobile" data-name="执行人电话" data-show="True"></li>
                    <li data-field="yhZxrName" data-name="执行人姓名" data-show="True"></li>
                    <li data-field="yhWz" data-name="隐患位置" data-show="True"></li>
                    <li data-field="PfSign" data-name="再次发生" data-show="True"></li>
                    <li data-field="yhFile" data-name="附件" data-show="True"></li>
                    <li data-field="yhCpDT" data-name="完成时限" data-show="True"></li>
                    <li data-field="yhCpDT1" data-name="完成时限时间" data-show="True"></li>
                    <li data-field="yhPrsnLogo" data-name="发现人LOGO" data-show="False"></li>
                    <li data-field="yhContent" data-name="隐患描述" data-show="False"></li>

                    <li data-field="yhfq" data-name="发生类型" data-show="False"></li>
                    <li data-field="deptName" data-name="部门" data-show="False"></li>
                    <li data-field="yhfswz_name" data-name="发生位置" data-show="False"></li>
                    <li data-field="yhfswz_bd_name" data-name="具体位置" data-show="False"></li>
                </ul>
            </div>

            <div id="listView0" data-type="listview" data-fms-templ="ReplyListTemp" data-fms-type="listview" class="list-group" data-source="v_yh_zlfs_msg_file" data-fms-list-currentpage="1" data-fms-list-key="MsgDT,ID" data-fms-list-conditions="FormID:fms.local.getJson('yh_main').FormID;" data-fms-list-itemclick="" data-fms-list-success="" data-paging="True" data-pagingtype="0" data-dataconfig="YH-018" data-datapagesize="20" data-datatype="0" data-primary="FormID" data-fms-datasource="YH-018">
                <ul style="display:none;" data-type="listview_info" data-title="MsgContent">
                    <li data-field="FormID" data-name="隐患编号" data-show="False"></li>
                    <li data-field="MsgContent" data-name="回复内容" data-show="True"></li>
                    <li data-field="MsgRelayPrsnName" data-name="回复人" data-show="True"></li>
                    <li data-field="MsgRelay" data-name="回复人编号" data-show="False"></li>
                    <li data-field="MsgDT" data-name="回复时间" data-show="True"></li>
                    <li data-field="MsgType" data-name="类型" data-show="True"></li>
                    <li data-field="MsgContent_cutting" data-name="缩略图" data-show="True"></li>
                    <li data-field="RelayPrsnLogoFile" data-name="回复人LOGO" data-show="True"></li>
                    <li data-field="MsgRelayPrsnMobile" data-name="手机" data-show="True"></li>
                </ul>
            </div>

        </div>

        <div class="footer">
            <div class="ub ub-f1 ubt bc-border ">
                <div class="ub ub-ac ub-pc ">
                    <div class="fa fa-comments-o btn ub ub-ac  ub-pc  c-7f8 uc-a1 btn-item-action" id="replay">
                        回复
                    </div>
                </div>
                <div class="ub ub-ac ub-pc ">
                    <div class="fa fa-reply-all btn ub ub-ac  ub-pc c-7f8 uc-a1 btn-item-action" id="zhuanfa">
                        转发
                    </div>
                </div>
                <div class="ub ub-ac ub-pc">
                    <div class="fa fa-external-link btn ub ub-ac  ub-pc c-7f8 uc-a1 btn-item-action" id="zgcs">
                        整改措施
                    </div>
                </div>
                <div class="ub ub-f1 ub-pe ub-ac">
                    <div class="fa fa-plus-circle fa-lg btn ub ub-ac c-7f8 ub-pc  uc-a1 btn-item-action" id="btn_op"></div>
                </div>
            </div>
        </div>

    </div>
</body>
<script>
        var IS_LoadUnreadQty = false;

        var  yhGradeT="";
        var G_Next2YhStat = ""

        appcan.ready(function() {
            fms.sqlite.created();
            uexWindow.setReportKey('1', '1');
            //一个是菜单键
            uexWindow.setReportKey('0', '1');
            //一个是返回键
            //拦截设备按键
            uexWindow.onKeyPressed = function(keyCode) {
                if (parseInt(keyCode, 10) === 0) {
                    //uexWindow.windowBack(1, 200);
                    goBack();
                } else if (parseInt(keyCode, 10) === 1) {
                    $("#navmenu").trigger("switch");
                }
            };
            $(document).dequeue("un");
        });

        //重新返回方法
        function goBack() {
            //console.log('shuaxin yh_qun_list.html')
            var PrevPage1 = fms.local.getKey('PrevPage1');
            if(PrevPage1){
                appcan.window.evaluateScript(PrevPage1, 'CurrentRefreshPage();');
            }
            appcan.window.close(-1);
        }

        var $$ = appcan.require('dom');
        var loginSession = fms.local.getJson("loginSession");

        $(".footer").on("click", ".btn-item-action", function(event) {
            var yh_info = fms.local.getJson("yh_info");
            //当前阶段
            var yhStat = yh_info.yhStat;
            var _id = $(this).attr("id");
            if (_id === 'replay') {//回复
                if (yhStat === '销号') {
                    alertEx('当前隐患处于销号状态，禁止操作！')
                } else {
                    gotoReplay();
                }
            } else if (_id === 'zhuanfa') {//转发
                if (yhStat === '销号') {
                    alertEx('当前隐患处于销号状态，禁止操作！')
                } else {
                    gotoForward();
                }
            } else if (_id === 'zgcs') {//整改措施
                if (yhStat === '销号') {
                    alertEx('当前隐患处于销号状态，禁止操作！')
                } else {
                    zgcs();
                }
            } else if (_id === 'btn_op') {//更多
                moreActionPanel();
            }
        });

        function gotoReplay() {
            fms.window.open("yh_reply.html");
        }

        function gotoForward() {
            fms.window.open("yh_forward.html");
        }

        function zgcs() {
            fms.local.setKey("TransferType", "EDIT");
            //   fms.local.setKey("FormID",fms.local.getJson('yh_main').FormID);
            fms.window.open("yh_zgcs.html");
        }

        function more(obj) {
            var ele = $("#more").find("i");
            if (ele.hasClass("fa-angle-down")) {
                ele.removeClass("fa-angle-down");
                ele.addClass("fa-angle-up");
            } else {
                ele.removeClass("fa-angle-up");
                ele.addClass("fa-angle-down");
            }
            //console.log($(obj).parent())
            $(obj).parent().addClass("uhide");
            $("#morediv").removeClass("uhide");
        }

        function moreActionPanel() {
            var yh_info = fms.local.getJson("yh_info");
               yhGradeT =yh_info.yhGrade;
            var yh_prsn_info = fms.local.getJson("yh_prsn_info");
            //{"items":[{"tip":"总监理工程师/安质部长/工程部长/","IsEnable":"0","NextYhStat":"响应"}]}
            //NextYhStat   下一阶段
            //tip          有执行权限的单位
            //IsEnable     是否有执行权限   0没有  1有
            $.api.auth({
                method : "bcp.sql.execute",
                pName : "getYhInfo",
                checkParam : true,
                formid : yh_info.FormID,
                userid : loginSession.username
            }, function(data) {
                //console.log(JSON.stringify(data));
                if (!fms.isNull(data.items) && data.items.length) {
                    var NextYhStat = data.items[0].NextYhStat;
                    var tip = data.items[0].tip;
                    var IsEnable = data.items[0].IsEnable;
                    var html = createOpWrap(NextYhStat);
                    layer.open({
                        type : 1,
                        content : html,
                        style : 'position:fixed; bottom:0; left:0; width:100%;border:none;'
                    });

                    setTimeout(function() {
                        $('#yhzxr').cRefresh(true);
                            Input_DateTime($('#yhDay')[0]);
                    }, 0);

                    $('#yhzxr').off('change');
                    $('#yhzxr').on('change', function() {
                        bindAction();
                    });
$("#yhDay").on("input",function(){
    bindAction();
        })
                   setTimeout(function() {
                        $('#yhzxr').trigger('change');
                    }, 100);
    window.__bindAction = bindAction;
                    function bindAction() {
                        var _yhzxr = $.trim($('#yhzxr').val());
                        var _yhDay = $.trim($('#yhDay').val());
                              $("#showyhDay").hide();
                          if(  NextYhStat === '响应' ||  NextYhStat === '复核' ){
                          $("#showyhDay").show();
                        }
                        if ((_yhzxr.length !== 0 && _yhDay.length !== 0 ) || NextYhStat === '销号' ) {
                            $(".p_errorMsg").html('');
                            if (NextYhStat === '销号') {
                                if (IsEnable === "0") {
                                    $("#btn_quit_yh").addClass("disabled");
                                } else {
                                    $("#btn_quit_yh").removeClass("disabled");
                                    $("#btn_quit_yh").off('click', btn_quit_yh);
                                    $("#btn_quit_yh").on('click', btn_quit_yh);
                                }
                            } else {
                                if (IsEnable === "0") {
                                    $("#btn_finish").addClass("disabled");
                                } else {
                                    $("#btn_finish").removeClass("disabled");
                                    $("#btn_finish").off('click', btn_finish);
                                    $("#btn_finish").on('click', btn_finish);

                                    /*if (NextYhStat === '复核') {
                                        //复核增加了，整改功能
                                        var btn_zg_html = '<div class="btn ub ub-ac bc-text-head ub-pc bc-btn ub-f1 uc-a1" style="margin-left:.5em !important;" id="btn_re_zhenggai">重新整改</div>';

                                        if($("#btn_re_zhenggai").length === 0){
                                            $(".btn-yh-level-action-panel").append(btn_zg_html);
                                        }
                                        $("#btn_re_zhenggai").removeClass("disabled");
                                        $("#btn_re_zhenggai").off('click', btn_fix_yh);
                                        $("#btn_re_zhenggai").on('click', btn_fix_yh);
                                    }*/
                                }
                            }
                        }
} else {
 else if ( _yhzxr.length===0 || _yhDay.length===0 ){ 451 $(".p_errorMsg").html('请选择执行人');

 $(".p_errorMsg").html( _yhzxr.length===0 ? '请选择执行人 ！' : (_yhDay.length===0 && (NextYhStat === '响应' || NextYhStat === '复核') ? '请选择整改时限！' : ''));
                            $("#btn_quit_yh").addClass("disabled");
                            $("#btn_quit_yh").off('click', btn_quit_yh);

                            $("#btn_finish").addClass("disabled");
                            $("#btn_finish").off('click', btn_finish);

                            //$("#btn_re_zhenggai").addClass("disabled");
                            //$("#btn_re_zhenggai").off('click', btn_fix_yh);
                        }
                        if ( NextYhStat === '复核' && yhGradeT==='一般'){

                                    $("#btn_quit_yh").removeClass("disabled");
                                    $("#btn_quit_yh").off('click', btn_quit_yh);
                                    $("#btn_quit_yh").on('click', btn_quit_yh);

}

                        if(NextYhStat !== '销号' && IsEnable !== "0" && NextYhStat === '复核'){
                            //复核增加了，整改功能
                            var btn_zg_html = '<div class="btn ub ub-ac bc-text-head ub-pc bc-btn ub-f1 uc-a1" style="margin-left:.5em !important;" id="btn_re_zhenggai">重新整改</div>';

                            if($("#btn_re_zhenggai").length === 0){
                                $(".btn-yh-level-action-panel").append(btn_zg_html);
                            }
                            $("#btn_re_zhenggai").removeClass("disabled");
                            $("#btn_re_zhenggai").off('click', btn_fix_yh);
                            $("#btn_re_zhenggai").on('click', btn_fix_yh);
                        }else{
                            $("#btn_re_zhenggai").addClass("disabled");
                            $("#btn_re_zhenggai").off('click', btn_fix_yh);
                        }

                    }

                    //当前状态为销号，下一阶段状态为null ，显示完成
                    if (String(NextYhStat) === 'null') {
                        $("#btn_finish").addClass("disabled");
                    }

                    if (!fms.isNull(tip)) {
                        var _html = '<div class="ub ub-f1 ulev-1 c-06c" style="padding-top:.5em;">' + tip + '</div>';
                        $(".NextYhActionPersnWrap").html(_html);
                    }
                }
            });
        }

        function createOpWrap(name1, name2) {
            name1 = name1 ? name1 : '完成';
            var eleIDName = name1 === '销号' ? 'btn_quit_yh' : 'btn_finish';
          if(yhGradeT==='一般'&&name1==='复核'){eleIDName='btn_quit_yh';  }
            var html = '<div class="ub ub-f1 uinn ub-ver">'
            + '    <li data-type="form_combo" style="padding:.5em 0 !important;">   '
            + '     <div class="form-group" style="padding-bottom:.75em;" >   '
//           + '   <label for="yhzxr" class="col-xs-5 control-label" style="width:43%">下一步执行人：　</label>  '
  if(!(yhGradeT==='一般'&&name1==='复核')){
html+= '   <label for="yhzxr" class="col-xs-5 control-label" style="width:40%">'+G_Next2YhStat+'：　</label>  '

           + '       <select id="Next2YhStat" disabled="disabled" class="col-xs-5 control-label"    required="required" data-search="off" data-fms-type="combobox" data-fms-datasource="YH-050"  data-fms-combobox-relation="" data-fms-combobox-conditions="FormID:fms.local.getJson(\'yh_main\').FormID;"></select> '
                 }

            html+= '        <div class="col-xs-7" style="width:57%" >   '


            + '          <select id="yhzxr" class="form-control input-lg" required="required" data-search="off" data-fms-type="combobox" data-fms-datasource="YH-050" data-fms-combobox-relation="" data-fms-combobox-conditions="FormID:fms.local.getJson(\'yh_main\').FormID;">  '
            + '          </select>  '
            + '        </div>   '
            + '      </div>   '
            + '    </li> '


            + '     <div class="form-group"  id="showyhDay"    style="padding-bottom:.75em;" >   '
            + '   <label for="yhzxr" class="col-xs-5 control-label" style="width:40%">整改时限 :　</label>  '


            + '     <div class="col-xs-7" data-type="form_time" style="width:59%">'
            + '         <input id="yhDay" class="form-control" type="text" value="" required="required" readonly="readonly" data-search="off" data-fms-type="date" data-fms-datetime-type="date" data-fms-datetime-current="false" data-fms-datetime-config="true" data-fms-datetime-mark="=" data-fms-datetime-create="yyyy-MM-dd">'
            + '        </div>'
            + '      </div>   '


             + '   <p class="p_errorMsg ulev-1"></p> '
            + '<div class="ub ub-f1 ub-ac btn-yh-level-action-panel">'
            + '<div class="btn ub ub-ac bc-text-head ub-pc bc-btn ub-f1 uc-a1 disabled " id="' + eleIDName + '">' + (name1=='整改'?'整改完成':name1=='复核'?'确认已整改':name1) + '</div>'
            + '</div>'
            + '<div class="ub ub-f1 NextYhActionPersnWrap"></div>'
            + '</div>';
            return html;
        }

        //确认完成
        function btn_finish() {
            appcan.window.alert({
                title : "提示",
                content : "确认要执行该操作吗？",
                buttons : ['确定', '取消'],
                callback : function(err, data, dataType, optId) {
                    data = String(data);
                    if (data === "0") {
                        finishAction();
                    } else {

                    }
                }
            });

            function finishAction() {
                var yh_info = fms.local.getJson("yh_main");
                var _yhStatChangeTimeX = $.trim($('#yhDay').val());
              alert(_yhStatChangeTimeX);
                var userinfo = fms.local.getJson("loginSession");
                if (yh_info && userinfo) {
                    fms.api.auth({
                        method : "bcp.sql.execute",
                        pName : "yhjdDone",
                        checkParam : true,
                        formid : yh_info.FormID,
                        userid : userinfo.username,
                        yhzxr : fms.isNull($('#yhzxr').val()) ? 'NULL' : $('#yhzxr').val()
                      , yhStatChangeTimeX:_yhStatChangeTimeX.length=0?'0':_yhStatChangeTimeX

                    }, function(data) {

                        layer.closeAll();
                        alertEx(data.items[0].name, function() {
                            window.location.reload(false);
                        });
                        //fms.window.open('yh_main.html');

                    });
                }
                removeEventHandler();
            }

        }

        //销号
        function btn_quit_yh() {

            appcan.window.alert({
                title : "提示",
                content : "确认要执行该操作吗？",
                buttons : ['确定', '取消'],
                callback : function(err, data, dataType, optId) {
                    data = String(data);
                    if (data === "0") {
                        quitAction();
                    } else {

                    }
                }
            });

            function quitAction() {
                var yh_info = fms.local.getJson("yh_main");

                var userinfo = fms.local.getJson("loginSession");
                if (yh_info && userinfo) {
                    fms.api.auth({
                        method : "bcp.sql.execute",
                        pName : "yhjdXH",
                        checkParam : true,
                        formid : yh_info.FormID,
                        userid : userinfo.username,
                    }, function(data) {

                        layer.closeAll();
                        alertEx(data.items[0].name, function() {
                            window.location.reload(false);
                        });
                        // if (data.items[0].code==0)
                        //fms.window.open('yh_main.html');
                    });
                }
                removeEventHandler();
            }

        }

        //重新整改
        function btn_fix_yh() {
            appcan.window.alert({
                title : "提示",
                content : "确认要执行该操作吗？",
                buttons : ['确定', '取消'],
                callback : function(err, data, dataType, optId) {
                    data = String(data);
                    if (data === "0") {
                        fixYhAction();
                    } else {

                    }
                }
            });

            function fixYhAction() {
                var yh_info = fms.local.getJson("yh_main");
                var userinfo = fms.local.getJson("loginSession");
                if (yh_info && userinfo) {
                    fms.api.auth({
                        method : "bcp.sql.execute",
                        pName : "reZG",
                        checkParam : true,
                        formid : yh_info.FormID,
                        userid : userinfo.username,
                    }, function(data) {
                        layer.closeAll();
                        alertEx(data.items[0].name, function() {
                            window.location.reload(false);
                        });

                        // if (data.items[0].code==0)
                        //fms.window.open('yh_main.html');
                    });
                }
                removeEventHandler();
            }

        }

        //清除事件
        function removeEventHandler() {
            //console.log('removeEventHandler...')
            //$(document).off("click","#btn_finish",btn_finish);
            //$(document).off("click","#btn_quit_yh",btn_quit_yh);
        }

        //BtnBoxWrapTemp

        function YHAction(context, data) {
            if (data && data.items && data.items.length) {
                var item = data.items[0];
                //console.log(item);
                fms.local.setJson("yh_info", item);

                setTimeout(function() {
                    getGroupMemberInfo();
                }, 1);
            }


            if(!IS_LoadUnreadQty){
                IS_LoadUnreadQty = true
                loadUnreadQty()
            }
        }

        function showContent(obj) {
            var item = $(obj).attr("data-item");
            item = JSON.parse(item);
            var _base_url_ = downip + "uploads/";

            var url = _base_url_ + item.MsgContent;
            var filename = item.MsgContent;
            var MsgType = item.MsgType;

            if (MsgType === 'text') {
                return;
            } else if (MsgType === "ppt" || MsgType === "txt" || MsgType === "word" || MsgType === "excel" || MsgType === "pdf") {
                readTxt(url, filename);
            } else if (MsgType == "image") {
                //uexImageBrowser.open([url], 0);
                var __options__ = {
                    displayActionButton : true,
                    displayNavArrows : true,
                    enableGrid : true,
                    //startOnGrid:true,
                    startIndex : 0,
                    data : [url]
                };
                uexImage.openBrowser(JSON.stringify(__options__));
            } else if (MsgType == "audio") {
                openAudio(url, filename);
                //openAudio123(url,filename);
            } else {
                layer.open({
                    content : '不支持打开该类型的文件'
                });
            }

            function readTxt(url, filename) {
                fms.sync.downFile(url, "wgt://data/" + filename + "", function(_f_name) {
                    uexDocumentReader.openDocumentReader(_f_name);
                });
            }

            function openAudio(url, filename) {
                fms.sync.downFile(url, "wgt://data/" + filename + "", function(_f_name) {
                    uexAudio.open(_f_name);
                    uexAudio.play(0);
                });
            }

        }

        //处理附件显示问题
        function formatFileName() {
        }

        //拨打电话
        $$("#content").on("click", ".mobile-call-action", function() {
            var phoneNumber = $(this).attr("data-phone-number");
            phoneNumber = $.trim(phoneNumber);
            if (phoneNumber.length) {
                uexCall.dial(phoneNumber);
            }else{
                alertEx('该用户没有设置手机号码');
                return;
            }
        });

        function getGroupMemberInfo(callback) {
            var QNO = fms.local.getJson('yh_info').QNO;
            $.api.auth({
                method : "bcp.list.get",
                key : 'id',
                module : 'YH-036',
                page : '1',
                pagesize : '50',
                type : 'before',
                QNO : QNO,
                PrsnID : loginSession.username
            }, function(data) {

                if (data && data.items && data.items.length) {
                    fms.local.setJson("yh_prsn_info", data.items[0]);
                    callback && callback(data.items[0]);
                }
            });
        }


        function loadUnreadQty(){
            fms.api.auth({
                method : "bcp.sql.execute",
                pName : "setDataIsRead",
                checkParam : true,
                userid : fms.local.getJson('loginSession').username,
                readtype : '1',
                dataid : fms.local.getJson('yh_main').FormID
            }, function(data) {

                /*fms.api.auth({
                    method : "bcp.sql.execute",
                    pName : "getDataIsRead",
                    checkParam : true,
                    userid : fms.local.getJson('loginSession').username,
                    readtype : '1',
                    dataid : 'NULL'
                }, function(data1) {
                    fms.local.setKey("daiban", data1.items[0].qty);
                    fms.local.setKey("chakan", data1.items[1].qty);
                    fms.local.setKey("qunzu", data1.items[2].qty);

                });*/

            });
        }
        /* templatetempl_listView0js */
       function getNextPrsnText(callback) {
            $.api.auth({
                method : "bcp.item.get",
                key : 'id',
                module : 'YH-063',
                FormID:fms.local.getJson('yh_main').FormID
            }, function(data) {
                G_Next2YhStat = '请选择'+data.Next2YhStat+'人'
                callback && callback(data.Next2YhStat)
            });
        }

        getNextPrsnText();
</script>
<script>
appcan.select(".select",function(ele,value){
  console.log(value);
  });
</script>
</html>